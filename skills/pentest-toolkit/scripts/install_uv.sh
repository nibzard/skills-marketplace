#!/bin/bash
# uv installation helper script for the AI-Powered Security Testing Toolkit

set -e

echo "AI-Powered Security Testing Toolkit - uv Installer"
echo "=================================================="
echo

# Check if uv is already installed
if command -v uv &> /dev/null; then
    echo "[+] uv is already installed: $(uv --version)"
    exit 0
fi

echo "[*] uv not found. Installing uv..."

# Detect OS and architecture
OS=$(uname -s)
ARCH=$(uname -m)

case $OS in
    Linux)
        PLATFORM="linux"
        ;;
    Darwin)
        PLATFORM="macos"
        ;;
    *)
        echo "[-] Unsupported OS: $OS"
        echo "    Please install uv manually from: https://github.com/astral-sh/uv"
        exit 1
        ;;
esac

case $ARCH in
    x86_64)
        ARCH_SUFFIX="x86_64"
        ;;
    arm64|aarch64)
        ARCH_SUFFIX="aarch64"
        ;;
    *)
        echo "[-] Unsupported architecture: $ARCH"
        exit 1
        ;;
esac

# Download and install uv
UV_VERSION="0.5.4"  # Update as needed
UV_URL="https://github.com/astral-sh/uv/releases/download/${UV_VERSION}/uv-${PLATFORM}-${ARCH_SUFFIX}.tar.gz"

echo "[*] Downloading uv from: $UV_URL"

# Create temporary directory
TEMP_DIR=$(mktemp -d)
cd "$TEMP_DIR"

# Download uv
if command -v curl &> /dev/null; then
    curl -L "$UV_URL" -o uv.tar.gz
elif command -v wget &> /dev/null; then
    wget "$UV_URL" -O uv.tar.gz
else
    echo "[-] Neither curl nor wget found. Please install uv manually."
    exit 1
fi

# Extract uv
tar -xzf uv.tar.gz

# Install to user's local bin
INSTALL_DIR="$HOME/.local/bin"
mkdir -p "$INSTALL_DIR"

cp uv "$INSTALL_DIR/uv"
chmod +x "$INSTALL_DIR/uv"

# Clean up
cd /
rm -rf "$TEMP_DIR"

# Verify installation
if command -v uv &> /dev/null; then
    echo "[+] uv installed successfully: $(uv --version)"
    echo
    echo "[*] To use uv with the security toolkit:"
    echo "    1. Ensure ~/.local/bin is in your PATH"
    echo "    2. Run: ./pentest-toolkit --setup"
    echo
    echo "[*] Add to PATH (run this once):"
    echo "    export PATH=\"\$HOME/.local/bin:\$PATH\""
    echo "    echo 'export PATH=\"\$HOME/.local/bin:\$PATH\"' >> ~/.bashrc"
else
    echo "[-] Installation failed. Please add ~/.local/bin to your PATH and try again."
    exit 1
fi